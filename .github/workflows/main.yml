name: Deploy Backend

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Deploy backend to EC2
      - name: Deploy Backend to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          GITHUB_SHA: ${{ github.sha }}
          BRANCH_NAME: ${GITHUB_REF##*/}
        run: |
          echo "ðŸš€ Starting deployment process..."
          echo "Branch: ${GITHUB_REF##*/}"
          echo "Commit: $GITHUB_SHA"
          
          echo "ðŸ“ Setting up SSH key..."
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          
          ssh -o StrictHostKeyChecking=no -i private_key $EC2_USERNAME@$EC2_HOST << EOF
            set -e  # Exit on any error
          
            echo "ðŸ” Checking system status..."
            df -h
            docker system df
            echo "Memory usage:"
            free -h
          
            echo "ðŸ“‚ Setting up deployment directory..."
            mkdir -p ~/aion-api
            cd ~/aion-api

            echo "ðŸ³ Checking Docker status..."
            docker ps
          
            echo "ðŸ›‘ Stopping existing container..."
            if docker ps -a | grep -q aion-api; then
              echo "Found existing container. Stopping and removing..."
              docker stop aion-api || true
              docker rm aion-api || true
            else
              echo "No existing container found."
            fi

            # Determine which branch to use
            DEPLOY_BRANCH="${GITHUB_REF##*/}"
            echo "ðŸŒ¿ Deploying branch: $DEPLOY_BRANCH"

            echo "ðŸ“¥ Setting up repository..."
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin
              echo "Checking out branch: $DEPLOY_BRANCH"
              git checkout $DEPLOY_BRANCH || git checkout -b $DEPLOY_BRANCH origin/$DEPLOY_BRANCH
              git pull origin $DEPLOY_BRANCH
              git reset --hard origin/$DEPLOY_BRANCH
              echo "Current git status:"
              git status
            else
              echo "Cloning fresh repository..."
              git clone -b $DEPLOY_BRANCH https://github.com/${{ github.repository }}.git .
            fi
          
            echo "âœ… Verifying branch..."
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [ "$CURRENT_BRANCH" != "$DEPLOY_BRANCH" ]; then
              echo "âŒ Error: Wrong branch! Expected $DEPLOY_BRANCH, got $CURRENT_BRANCH"
              exit 1
            fi
            echo "Current commit: $(git rev-parse HEAD)"
          
            echo "ðŸ” Checking repository structure..."
            ls -la
            if [ ! -d "backend" ]; then
              echo "âŒ Error: backend directory not found!"
              exit 1
            fi
          
            echo "ðŸ“¦ Checking backend directory contents..."
            ls -la backend/
          
            echo "ðŸ—ï¸ Building Docker image..."
            echo "Using Dockerfile at: backend/Dockerfile"
            cat backend/Dockerfile
            docker build -t aion-api:$GITHUB_SHA -f backend/Dockerfile backend/
          
            echo "âœ… Verifying built image..."
            docker images | grep aion-api
          
            echo "ðŸš€ Starting container..."
            if [ "$DEPLOY_BRANCH" = "dev" ]; then
              echo "ðŸ”§ Using development environment variables..."
              docker run -d \
                --name aion-api \
                --restart always \
                -p 5000:5000 \
                -e DB_SERVER='${{ secrets.DEV_DB_SERVER }}' \
                -e DB_NAME='${{ secrets.DEV_DB_NAME }}' \
                -e DB_USER='${{ secrets.DEV_DB_USER }}' \
                -e DB_PASSWORD='${{ secrets.DEV_DB_PASSWORD }}' \
                -e AWS_S3_BUCKET='${{ secrets.DEV_AWS_BUCKET_NAME }}' \
                -e AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY_ID }}' \
                -e AWS_SECRET_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
                -e CORS_ORIGINS='${{ secrets.DEV_CORS_ORIGINS }}' \
                aion-api:$GITHUB_SHA
            else
              echo "ðŸ”§ Using production environment variables..."
              docker run -d \
                --name aion-api \
                --restart always \
                -p 5000:5000 \
                -e DB_SERVER='${{ secrets.PROD_DB_SERVER }}' \
                -e DB_NAME='${{ secrets.PROD_DB_NAME }}' \
                -e DB_USER='${{ secrets.PROD_DB_USER }}' \
                -e DB_PASSWORD='${{ secrets.PROD_DB_PASSWORD }}' \
                -e AWS_S3_BUCKET='${{ secrets.PROD_AWS_BUCKET_NAME }}' \
                -e AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY_ID }}' \
                -e AWS_SECRET_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
                -e CORS_ORIGINS='${{ secrets.PROD_CORS_ORIGINS }}' \
                aion-api:$GITHUB_SHA
            fi

            echo "âœ… Verifying container status..."
            docker ps | grep aion-api
            if ! docker ps | grep -q aion-api; then
              echo "âŒ Error: Container failed to start!"
              echo "ðŸ“‹ Container logs:"
              docker logs aion-api
              exit 1
            fi
          
            echo "ðŸ” Checking container health..."
            sleep 5  # Wait for container to initialize
            docker logs aion-api
          
            echo "ðŸ§¹ Cleaning up old images..."
            echo "Before cleanup:"
            docker image ls
            docker image prune -a --force --filter "until=72h"
            echo "After cleanup:"
            docker image ls
          
            echo "ðŸ“Š Final system status:"
            df -h
            docker system df
          
            echo "âœ… Deployment completed successfully!"
            echo "Branch: $DEPLOY_BRANCH"
            echo "Commit: $GITHUB_SHA"
            echo "Container ID: $(docker ps -q -f name=aion-api)"
          EOF